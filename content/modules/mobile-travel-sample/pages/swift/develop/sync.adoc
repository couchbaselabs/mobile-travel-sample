= Sync
:source-language: swift

== Data Routing

In the xref:tutorials:mobile-travel-sample:{source-language}/develop/security.adoc[Access Control] lesson we discussed how Sync Gateway supports Authorization and Access Control functions.
In this lesson we discuss how it can be used for Data Synchronization and Routing. 

A Sync Gateway configuration file determines the runtime behavior of Sync Gateway, including server configuration and the database or set of databases with which a Sync Gateway instance can interact. 

Sync Gateway uses channels to make it easy to share a database between a large number of users and control access to the database. Conceptually, a channel could be viewed as a tag. Every document in the database belongs to a set of channels, and a user is granted appropriate access a set of channels. A channel is used to:

* Partition the data set.
* Authorize users to access documents.
* Minimize the amount of data synced down to devices. 

In the xref::installation/index.adoc[backend installation] section, we walked you through the steps to launch Sync Gateway with a specific config file.

Open the sync-gateway-config-travelsample.json file located at https://github.com/couchbaselabs/mobile-travel-sample/blob/master/sync-gateway-config-travelsample.json.
It includes the `sync function` which is a JavaScript function whose source code is stored in the Sync Gateway's database configuration file. 

[source,javascript]
----
/* Routing */
// Add doc to the user's channel.
channel("channel." + username);
----

== XAttrs

Before you begin this lesson, confirm that you have Sync Gateway up and running by following the instructions in the xref::installation/index.adoc[backend installation] section.

Starting with Sync Gateway 1.5 and Couchbase Server 5.0, mobile and server/web applications now have the ability to read and write to the same bucket.
It is an opt-in feature can be enabled in the Sync Gateway configuration file.

image::https://raw.githubusercontent.com/couchbaselabs/mobile-travel-sample/master/content/assets/convergence.png[]

Prior to 1.5, sync metadata used by the Sync Gateway for replication with mobile clients was included within the documents as part of the `_sync` property.
In 1.5, the sync metadata is moved into the Extended Attributes or XAttrs associated with the document.

This can be enabled through a configuration setting in the sync gateway config file.

Open the sync-gateway-config-travelsample.json file located at https://github.com/couchbaselabs/mobile-travel-sample/blob/master/sync-gateway-config-travelsample.json

[source,javascript]
----
"import_docs": "continuous",
"enable_shared_bucket_access": true
----

You can specify the Couchbase Server documents that need to be imported and processed by the Sync Gateway.
In our demo, we will only be synchornizing the "user" document.
So every other document type is ignored. 

[source,javascript]
----
function(doc) {
  /* Just ignore all the static travel-sample files */
  if (doc._deleted == true ) {
    return true;
   }
  if (doc.type == "landmark" || doc.type == "hotel" || doc.type == "airport" || doc.type =="airline" || doc.type == "route") {
    return false;
  } 

  return true;
}
----

== Replication

Replication is the process by which clients running Couchbase Lite synchronize database changes with the remote (server) database. 

* Pull Replication is the process by which clients running Couchbase Lite download database changes from the remote (server) source database to the local target database 
* Push Replication is the process by which clients running Couchbase Lite upload database changes from the local source database to the remote (server) target database 

Couchbase Mobile 2.0 introduces a brand new replication protocol which is implemented as a messaging protocol layered over WebSocket.

image:http://blog.couchbase.com/wp-content/uploads/2018/02/replication2.0.png[]

The replication process can be "`continuous`" or "`one shot"`.

* In "`Continuous`" replication mode, the changes are continually synchronized between the client and Sync Gateway.
* In "`One shot`" mode, the changes are synchronized once and the connection between the client and server disconnects. When any future changes need to be pushed up or pulled down, the client must start a new replication.

*Open the file*``DatabaseManager.swift``.
We will review the method `func startPushAndPullReplicationForCurrentUser()`

https://github.com/couchbaselabs/mobile-travel-sample/blob/master/ios/TravelSample/TravelSample/Model/DatabaseManager.swift#L202[DatabaseManager.swift]

[source]
----
func startPushAndPullReplicationForCurrentUser() {
  ...
}
----

First, you fetch the URL of the Sync Gateway 

[source]
----
guard let remoteUrl = URL.init(string: kRemoteSyncUrl) else {
  lastError = TravelSampleError.RemoteDatabaseNotReachable

  return
}
----

Do some checks to confirm the validity of the database and user credentials 

[source]
----
guard let user = self.currentUserCredentials?.user,let password =   self.currentUserCredentials?.password  else {
  lastError = TravelSampleError.UserCredentialsNotProvided
  return
}

guard let db = db else {
  lastError = TravelSampleError.RemoteDatabaseNotReachable
  return
}
----

Verify that the replicator is not already in progress 

[source]
----
if _pushPullRepl != nil {
  // Replication is already started
  return
}
----

The `ReplicatorConfiguration` is initialized with the local database and URL of the target DB on Sync Gateway.
The `replicatorType` in the Replicator Config specifies the type of replication.
In the code snippet in the Travel app, it is `pushAndPull` indicating that both push and pull replication is enabled.
The `continuous` mode is set to `true` in the Travel app. 

[source]
----
fileprivate let kRemoteSyncUrl = "ws://localhost:4984"
let dbUrl = remoteUrl.appendingPathComponent(kDBName)

let config = ReplicatorConfiguration.init(database: db, target: URLEndpoint.init(url:dbUrl))

config.replicatorType = .pushAndPull
config.continuous =  true
----

The Replicator is configured with relevant authentication credentials.
In the Travel app, the list of users that are permitted access is configured in the Sync Gateway configuration file as discussed in the xref:tutorials:mobile-travel-sample:{source-language}/develop/security.adoc[Access Control] section.

[source]
----
config.authenticator = BasicAuthenticator(username: user, password: password)
----

The Replicator is configured to only pull from current user's channels.
The list of channels that the user has access to is defined in the Sync Gateway configuration file as discussed in the <<data-routing, Data Routing>> section.

[source]
----
// This should match what is specified in the sync gateway config
// Only pull documents from this user's channel
let userChannel = "channel.\(user)"
config.channels = [userChannel]
----

The Replicator is initialized with the specified configuration 

[source]
----
_pushPullRepl = Replicator.init(config: config)
----

A change listener callback block is registered to listen for replication changes.
Every time, there is a push or pull change, the callback is invoked. 

[source]
----
_pushPullReplListener = _pushPullRepl?.addChangeListener({ [weak self] (change) in
    let s = change.status
    print("PushPull Replicator: \(s.progress.completed)/\(s.progress.total), error: \(String(describing: s.error)), activity = \(s.activity)")

    if s.progress.completed == s.progress.total {
        self?.postNotificationOnReplicationState(.idle)
    }
    else {
        self?.postNotificationOnReplicationState(s.activity)
    }
})
----

Start the Replication 

[source]
----

_pushPullRepl?.start()
----

=== Try it out (Push Replication)

* Log into the Travel Sample Mobile app as "`demo`" user and password as "`password`" 
* Tap on "+" button to make a flight reservation 
* Enter "`From`" airport as SFO and select the airport from drop down menu 
* Enter "`To`" airport as DTW and select the airport from drop down menu 
* Enter From and Return Dates 
* Tap "lookup" button 
* From list of flights, select the first flight listing 
* Select "`Confirm Booking`" 
* Access the Travel Sample Web app. The URL would be http://localhost:8080. If you did cloud based install, please replace `localhost` in the URL with the IP Address of the cloud instance of the web app. 
* Make sure that the "New User" checkbox is *unchecked*
* Log into the web app as "`demo`" user with password as "`password`" 
* Confirm that you see the flight that you reserved via the mobile app in your list of flights in the web app 
+
image::https://raw.githubusercontent.com/couchbaselabs/mobile-travel-sample/master/content/assets/ios_push_sync.gif[]


=== Try it out (Pull Replication)

* Access the Travel Sample Web app. The URL *unchecked*
* Log into the web app as "`demo`" user with password as "`password`" 
* Make a flight reservation by clicking "booking" button. 
* Enter "`From`" airport as "San" and select the airport from drop down menu. 
* Enter "`To`" airport as "SFO" and select the airport from drop down menu. 
* Enter From and Return Travel Dates 
* Click on "Find Flights" button 
* From list of flights, select the first flight listing 
* Confirm the booking by clicking on the shopping cart icon and click on "`Book`" button 
* {empty}

  Log into the Travel Sample Mobile app as “demo” user and password as “password”
* Confirm that you see the flight that you reserved via the web app in your list of flights in the mobile app 
+
image::https://raw.githubusercontent.com/couchbaselabs/mobile-travel-sample/master/content/assets/ios_pull_sync.gif[]
